{% extends "base.html" %}
{% block content %}
  <style>
    .timeline {
      position: relative;
      padding: 20px 0;
      list-style: none;
    }
    .timeline:before {
      position: absolute;
      left: 30px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: #e9ecef;
      content: '';
    }
    .timeline-item {
      position: relative;
      margin-bottom: 20px;
      padding-left: 60px;
    }
    .timeline-item:before {
      position: absolute;
      left: 20px;
      top: 0;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #fff;
      border: 2px solid #6c757d;
      content: '';
    }
    .timeline-panel {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 10px;
    }
  </style>
  <div class="container">
    <h2 class="my-4">Comment Box 2024</h2>
    <p>This form is for reporting issues and comments within the school by the Student Committee on Student Affairs.</p>
    <form method="post" action="{{ url_for('comments') }}" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="form-group">
        {{ form.full_name.label }}:
        {{ form.full_name(class="form-control", placeholder="Enter your full name (optional)") }}
      </div>
      <div class="form-group">
        {{ form.status.label }}:
        <select class="form-control" name="status" id="status">
          <option value="Grade 9">Grade 9</option>
          <option value="Grade 10">Grade 10</option>
          <option value="Grade 11">Grade 11</option>
          <option value="Teacher & Personnel">Teacher & Personnel</option>
        </select>
      </div>
      <div class="form-group">
        {{ form.problem_comment.label }}:
        {{ form.problem_comment(class="form-control", rows="4", placeholder="Describe the problem or comment") }}
      </div>
      <div class="form-group">
        <label for="urgency">Urgency:</label>
        <div id="star-rating">
          {% for i in range(1, 11) %}
            <i class="far fa-star" data-value="{{ i }}"></i>
          {% endfor %}
        </div>
        <input type="hidden" name="urgency" id="urgency" value="5">
        <small class="form-text text-muted">Click stars to set urgency (1 = least urgent, 10 = most urgent)</small>
      </div>
      <script>
        const stars = document.querySelectorAll('#star-rating i');
        const urgencyInput = document.getElementById('urgency');
        // Set default rating if desired:
        const defaultRating = urgencyInput.value;
        stars.forEach(star => {
          if (parseInt(star.getAttribute('data-value')) <= defaultRating) {
            star.classList.remove('far');
            star.classList.add('fas');
          }
        });
        stars.forEach(star => {
          star.addEventListener('click', function(){
            const rating = this.getAttribute('data-value');
            urgencyInput.value = rating;
            stars.forEach(s => {
               if (parseInt(s.getAttribute('data-value')) <= rating) {
                   s.classList.remove('far');
                   s.classList.add('fas');
               } else {
                   s.classList.remove('fas');
                   s.classList.add('far');
               }
            });
          });
        });
      </script>
      <div class="form-group">
        {{ form.suggested_solution.label }}:
        {{ form.suggested_solution(class="form-control", rows="3", placeholder="Optional suggested solution") }}
      </div>
      <div class="form-group">
        {{ form.evidence.label }}:
        {{ form.evidence(class="form-control-file", multiple="multiple", accept=".doc,.docx,.xls,.xlsx,.ppt,.pptx,.pdf,image/*,video/*,audio/*") }}
        <small class="form-text text-muted">
          File number limit: 10; Single file size limit: 1GB.
        </small>
      </div>
      <div class="form-group">
        {{ form.contact.label }}:
        {{ form.contact(class="form-control", placeholder="Enter your contact information (optional)") }}
      </div>
      <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    </form>
    
    <hr>
    
    <h3>Existing Comments</h3>
    {% for comment in comments %}
      <div class="card my-2">
        <div class="card-body">
          {% set lines = comment.content.split('\n') %}
          {% for line in lines if line and not line.startswith('Urgency:') %}
            <p>{{ line }}</p>
          {% endfor %}
          {% if comment.urgency %}
            <div class="progress my-2">
              <div class="progress-bar bg-danger" role="progressbar" style="width: {{ comment.urgency*10 }}%;" aria-valuenow="{{ comment.urgency }}" aria-valuemin="1" aria-valuemax="10">
                Urgency: {{ comment.urgency }}
              </div>
            </div>
          {% endif %}
          {% if comment.evidence %}
            <div class="mt-2 text-center">
              <img src="{{ url_for('static', filename='uploads/comments/' ~ comment.evidence) }}"
                   alt="Evidence"
                   style="width: 100%; max-width: 500px; height: auto; max-height: 500px; object-fit: contain; display: block; margin: 0 auto;">
            </div>
          {% endif %}
          <small class="text-muted">
            Posted on: {{ comment.created_at|local_time }} | Category: {{ comment.category }}
          </small>
          {% if comment.replies %}
            <div class="timeline mt-3">
              {% for reply in comment.replies %}
                <div class="timeline-item">
                  <div class="timeline-panel">
                    <div class="timeline-heading mb-2">
                      <h6 class="mb-1">Reply: {{ reply.reply_text }}</h6>
                    </div>
                    <div class="timeline-body">
                      <p>
                        Status:
                        {% if reply.admin_status == 'coordinating' %}
                          <span class="badge badge-info">Coordinating</span>
                        {% elif reply.admin_status == 'in progress' %}
                          <span class="badge badge-warning">In Progress</span>
                        {% elif reply.admin_status == 'complete' %}
                          <span class="badge badge-success">Complete</span>
                        {% else %}
                          <span class="badge badge-secondary">{{ reply.admin_status }}</span>
                        {% endif %}
                      </p>
                      <p>Replied at: {{ reply.reply_time|local_time }}</p>
                      {% if reply.admin_image %}
                        <img src="{{ url_for('static', filename='uploads/comments/' ~ reply.admin_image) }}"
                             alt="Reply Evidence"
                             class="reply-thumbnail"
                             style="width: 100%; max-width: 500px; height: auto; max-height: 500px; object-fit: contain; display: block; margin: 0 auto;">
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
